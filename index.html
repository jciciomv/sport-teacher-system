<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Училишен систем - Спорт</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Спорт Систем">
    
    <style>
        /* (CSS кодот останува ист) */
        
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .login-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .login-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>
    
    <div class="offline-indicator" id="offlineIndicator">
        ⚠️ Офлајн режим - Податоците се локално зачувани
    </div>

    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2 class="login-title">Училишен систем - Спорт</h2>
            
            <div class="login-tabs">
                <div class="login-tab active" data-form="login">Најава</div>
                <div class="login-tab" data-form="signup">Регистрација</div>
            </div>
            
            <div id="loginForm" class="login-form active">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="Внесете email">
                </div>
                <div class="form-group">
                    <label>Лозинка</label>
                    <input type="password" id="loginPassword" placeholder="Внесете лозинка">
                </div>
                <button id="loginBtn" class="btn-success" style="width: 100%;">Најава</button>
            </div>
            
            <div id="signupForm" class="login-form">
                <div class="form-group">
                    <label>Име и презиме</label>
                    <input type="text" id="signupName" placeholder="Внесете име и презиме">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="Внесете email">
                </div>
                <div class="form-group">
                    <label>Лозинка</label>
                    <input type="password" id="signupPassword" placeholder="Внесете лозинка">
                </div>
                <div class="form-group">
                    <label>Потврди лозинка</label>
                    <input type="password" id="signupConfirmPassword" placeholder="Повторете ја лозинката">
                </div>
                <button id="signupBtn" class="btn-success" style="width: 100%;">Регистрирај се</button>
            </div>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <!-- (Остатокот на HTML кодот останува ист) -->
    </div>

    <script>
        class SchoolDB {
            constructor() {
                this.init();
            }

            init() {
                if (!localStorage.getItem('sportTeacherData')) {
                    const initialData = {
                        teachers: [],
                        students: [],
                        attendance: {},
                        tests: {},
                        schedule: {
                            'Понеделник': ['', '', '', '', '', '', ''],
                            'Вторник': ['', '', '', '', '', '', ''],
                            'Среда': ['', '', '', '', '', '', ''],
                            'Четврток': ['', '', '', '', '', '', ''],
                            'Петок': ['', '', '', '', '', '', '']
                        },
                        testBattery: [],
                        classes: []
                    };
                    this.saveData(initialData);
                }
            }

            // (Останатите методи остануваат исти, освен getData и saveData)
            
            getData() {
                const data = JSON.parse(localStorage.getItem('sportTeacherData')) || {};
                
                // Додаваме проверка за backward compatibility
                if (!data.teachers) data.teachers = [];
                if (!data.students) data.students = [];
                if (!data.attendance) data.attendance = {};
                if (!data.tests) data.tests = {};
                if (!data.schedule) {
                    data.schedule = {
                        'Понеделник': ['', '', '', '', '', '', ''],
                        'Вторник': ['', '', '', '', '', '', ''],
                        'Среда': ['', '', '', '', '', '', ''],
                        'Четврток': ['', '', '', '', '', '', ''],
                        'Петок': ['', '', '', '', '', '', '']
                    };
                }
                if (!data.testBattery) data.testBattery = [];
                if (!data.classes) data.classes = [];
                
                return data;
            }

            saveData(data) {
                localStorage.setItem('sportTeacherData', JSON.stringify(data));
            }

            // (Останатите методи остануваат исти)
        }

        class SportTeacherApp {
            constructor() {
                this.db = new SchoolDB();
                this.currentUser = null;
                this.currentDate = new Date().toISOString().split('T')[0];
                this.selectedStudentId = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupOfflineDetection();
                this.showLoginPage();
                
                // Проверка дали корисникот е веќе најавен
                const savedUser = localStorage.getItem('currentTeacher');
                if (savedUser) {
                    try {
                        this.currentUser = JSON.parse(savedUser);
                        const data = this.db.getData();
                        const teacherExists = data.teachers.some(t => t.id === this.currentUser.id);
                        
                        if (teacherExists) {
                            this.showApp();
                        } else {
                            localStorage.removeItem('currentTeacher');
                            this.showLoginPage();
                        }
                    } catch (e) {
                        localStorage.removeItem('currentTeacher');
                        this.showLoginPage();
                    }
                }
            }

            setupEventListeners() {
                // Логика за табовите
                document.querySelectorAll('.login-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const formType = e.target.getAttribute('data-form');
                        this.showLoginForm(formType);
                    });
                });

                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('signupBtn').addEventListener('click', () => this.signup());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('mobileMenuBtn').addEventListener('click', () => this.toggleMobileMenu());

                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.id !== 'logoutBtn') {
                        item.addEventListener('click', (e) => {
                            const page = e.target.getAttribute('data-page') || 
                                        e.target.closest('.nav-item').getAttribute('data-page');
                            this.showPage(page);
                            this.hideMobileMenu();
                        });
                    }
                });
            }

            showLoginForm(formType) {
                // Активирај го соодветниот таб
                document.querySelectorAll('.login-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-form="${formType}"]`).classList.add('active');

                // Прикажи го соодветниот формулар
                document.querySelectorAll('.login-form').forEach(form => {
                    form.classList.remove('active');
                });
                document.getElementById(`${formType}Form`).classList.add('active');
            }

            signup() {
                const name = document.getElementById('signupName').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;

                // Валидација
                if (!name || !email || !password) {
                    alert('Ве молам пополнете ги сите полиња');
                    return;
                }

                if (password !== confirmPassword) {
                    alert('Лозинките не се совпаѓаат');
                    return;
                }

                if (password.length < 6) {
                    alert('Лозинката мора да има најмалку 6 карактери');
                    return;
                }

                const data = this.db.getData();

                // Проверка дали email веќе постои
                if (data.teachers.some(t => t.email === email)) {
                    alert('Корисник со овој email веќе постои');
                    return;
                }

                // Креирај нов корисник
                const newTeacher = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    password: password,
                    subjects: ['Спорт'],
                    classes: []
                };

                data.teachers.push(newTeacher);
                this.db.saveData(data);

                alert('Успешно креиран акаунт! Ве молам најавете се.');
                this.showLoginForm('login');
                
                // Испразни ги полињата
                document.getElementById('signupName').value = '';
                document.getElementById('signupEmail').value = '';
                document.getElementById('signupPassword').value = '';
                document.getElementById('signupConfirmPassword').value = '';
            }

            login() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const data = this.db.getData();

                const teacher = data.teachers.find(t => t.email === email && t.password === password);
                if (teacher) {
                    this.currentUser = teacher;
                    localStorage.setItem('currentTeacher', JSON.stringify(teacher));
                    this.showApp();
                    alert(`Добредојдовте ${teacher.name}!`);
                } else {
                    alert('Погрешен email или лозинка');
                }
            }

            showApp() {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                
                // Ажурирај го корисничкото име и аватар
                document.querySelector('.avatar').textContent = 
                    this.currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                document.querySelector('.user-info span').textContent = this.currentUser.name;
                
                this.showPage('dashboard');
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('currentTeacher');
                document.getElementById('app').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                this.hideMobileMenu();
                
                // Ресетирај ги формуларите
                this.showLoginForm('login');
            }

            // (Останатите методи остануваат исти, но сега користат this.currentUser)
            
            getUniqueClasses() {
                const data = this.db.getData();
                // Филтрирај ги учениците според најавениот корисник
                const teacherStudents = data.students.filter(s => 
                    this.currentUser.classes.includes(s.class)
                );
                return [...new Set(teacherStudents.map(s => s.class))].sort();
            }

            // Додадете ги овие методи за да се осигурате дека секој корисник има свои податоци
            ensureTeacherData() {
                const data = this.db.getData();
                
                // Ако корисникот нема класи, додади ги стандардните
                if (this.currentUser.classes.length === 0) {
                    this.currentUser.classes = ['1У', '2У', '3У', '4У', '5У'];
                    
                    // Ажурирај го корисникот во базата
                    const teacherIndex = data.teachers.findIndex(t => t.id === this.currentUser.id);
                    if (teacherIndex !== -1) {
                        data.teachers[teacherIndex] = this.currentUser;
                        this.db.saveData(data);
                    }
                }
                
                // Ако нема ученици, додади ги стандардните
                if (data.students.length === 0) {
                    data.students = [
                        { id: 1, name: 'Јане Петровски', class: '5У', status: 'active', specialNeeds: '' },
                        { id: 2, name: 'Кава Марковска', class: '5У', status: 'excused', specialNeeds: 'Ослободен од спортување' },
                        { id: 3, name: 'Сам Јованов', class: '3У', status: 'active', specialNeeds: '' },
                        { id: 4, name: 'Ради Стојанов', class: '3У', status: 'handicap', specialNeeds: 'Хендикеп' },
                        { id: 5, name: 'Марко Иванов', class: '2У', status: 'active', specialNeeds: '' },
                        { id: 6, name: 'Ана Попова', class: '2У', status: 'active', specialNeeds: '' },
                        { id: 7, name: 'Софија Николова', class: '3У', status: 'active', specialNeeds: '' },
                        { id: 8, name: 'Никола Георгиев', class: '4У', status: 'active', specialNeeds: '' },
                        { id: 9, name: 'Елена Димитрова', class: '4У', status: 'handicap', specialNeeds: 'Хендикеп' },
                        { id: 10, name: 'Иван Алексов', class: '5У', status: 'active', specialNeeds: '' }
                    ];
                    this.db.saveData(data);
                }
                
                // Ако нема тестови, додади ги стандардните
                if (data.testBattery.length === 0) {
                    data.testBattery = [
                        { id: 1, name: 'Трчање 60м', unit: 'сек', lowerBetter: true },
                        { id: 2, name: 'Скок во далечина', unit: 'см', lowerBetter: false },
                        { id: 3, name: 'Флексии', unit: 'бр', lowerBetter: false },
                        { id: 4, name: 'Седење-исправување', unit: 'см', lowerBetter: false },
                        { id: 5, name: 'Трчање 1000м', unit: 'мин:сек', lowerBetter: true }
                    ];
                    this.db.saveData(data);
                }
                
                // Ако распоредот е празен, додади го стандардниот
                const isEmptySchedule = Object.values(data.schedule).every(day => 
                    day.every(hour => hour === '')
                );
                
                if (isEmptySchedule) {
                    data.schedule = {
                        'Понеделник': ['5У - Спорт', '3У - Спорт', '1У - Спорт', '', '', '', ''],
                        'Вторник': ['', '2У - Спорт', '4У - Спорт', '5У - Спорт', '', '', ''],
                        'Среда': ['3У - Спорт', '1У - Спорт', '', '2У - Спорт', '', '', ''],
                        'Четврток': ['', '4У - Спорт', '5У - Спорт', '3У - Спорт', '', '', ''],
                        'Петок': ['1У - Спорт', '2У - Спорт', '', '', '4У - Спорт', '', '']
                    };
                    this.db.saveData(data);
                }
            }

            showPage(pageName) {
                // Пред да се прикаже страницата, осигурај се дека корисникот има потребните податоци
                if (this.currentUser) {
                    this.ensureTeacherData();
                }
                
                // Останатиот код за прикажување на страницата останува ист
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const navItem = document.querySelector(`[data-page="${pageName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }

                document.getElementById('pageTitle').textContent = 
                    navItem ? navItem.querySelector('span:last-child').textContent : pageName;

                const pageElement = document.getElementById(`${pageName}Page`);
                if (pageElement) {
                    pageElement.classList.add('active');
                    this.loadPageContent(pageName);
                }
            }

            // (Останатите методи остануваат исти)
        }

        const app = new SportTeacherApp();
    </script>
</body>
</html>